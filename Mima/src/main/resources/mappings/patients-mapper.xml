<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mima.app.member.mapper.PatientsMapper">


<!-- e.29 -->
<!-- 관리자 회원정보조회 -->
<select id="getList" resultType="PatientsVO"> 
	SELECT MEMBER_NO
			,PAST_HX
			,PRE_SELF_AX
			,TOPIC
			,MED_DELIVERY
			,REG_DATE
			,EDIT_DATE
	FROM PATIENTS
</select> 

  
<!-- s:1004 pt preScreening -->
	<update id="update">
	UPDATE PATIENTS
		SET
			PAST_HX =#{pastHx},
			SESSION_REASON=#{sessionReason},
			PRE_DIAGNOSIS=#{preDiagnosis},
			CURRENT_MEDS=#{currentMeds},
			MORE_INFO=#{moreInfo} 
		WHERE MEMBER_NO=#{memberNo}
	</update>

<!-- s:1004 pt preScreening Ax result 머리가 쓰기 귀찮아서 그냥 이렇게 해 놓습니다... -->
	<update id="updateAx">
	UPDATE PATIENTS
		SET
			PRE_SELF_AX=#{preSelfAx}
		WHERE MEMBER_NO=#{memberNo}
	</update>


<!-- e.4 -->
<!-- 페이징 -->
<!-- trim 한 것 따로 빼 낸것... -->
	<sql id="criteria">
		<trim prefix="(" suffix=") AND " prefixOverrides="OR">
			<foreach collection="typeArr" item="type">
				<!-- 콜렉션에 소문자시작 typeArr 써주면 자동으로 getMathod를 불러주는거임 -->
				<trim prefix="or">
					<choose>
						<when test="type == 'T'.toString()">
							TITLE LIKE '%'|| #{keyword} || '%'
						</when>

						<when test="type =='C'.toString()">
							CONTENT LIKE '%'|| #{keyword} || '%'
						</when>

						<when test="type =='W'.toString()">
							WRITER LIKE '%'|| #{keyword} || '%'
						</when>
						<when test="type =='delivery'.toString()">
							DELIVERT_AREA LIKE '%'|| #{keyword} || '%'
						</when>
						
					</choose>
				</trim>
			</foreach>
		</trim>
	</sql>
	
	<!-- total count -->
	<select id="getTotalPatientsCount" resultType="int">
		SELECT COUNT(*) FROM PATIENTS
		WHERE
		<include refid="criteria"></include>
		MEMBER_NO > 0
	</select>

	<select id="getPatientsList" 
		resultType="com.mima.app.member.domain.PatientsVO">
		SELECT *
		FROM( SELECT /*+INDEX_DESC(PATIENTS PATIENTS_PK) */
		ROWNUM RN, MEMBER_NO, PAST_HX, PRE_SELF_AX, TOPIC, MED_DELIVERY
		FROM PATIENTS
		where
				
		<include refid="criteria"></include>
				<![CDATA[
				ROWNUM <= #{pageNum} * #{amount}				
				)
		WHERE RN > (#{pageNum}-1)* #{amount} ]]>
	</select>
<!-- 페이징 end -->

<!-- e.4 -->
<!--환자대쉬보드 Main 오늘의예약-->
<select id="ptgetList" resultType="BookingVO">
	SELECT B.BOOKING_NO,
		   B.PT_NO,
		   B.DOC_NO,
		   B.BOOKING_DATE,
		   B.PRICE,
		   B.BOOKING_STATUS,
		   B.CONSULT_DATE,
		   B.CONSULT_TIME,
		   M.NAME
	FROM BOOKING B JOIN MEMBER M
	ON B.PT_NO=M.MEMBER_NO
	WHERE B.CONSULT_DATE=TO_DATE(SYSDATE) AND MEMBER_NO=#{memberNo}
</select>

<!-- 환자대쉬보드 예약관리 페이지 e.5-->
<select id="ptbmList" resultType="BookingVO">
	SELECT B.BOOKING_NO,
		   B.PT_NO,
		   B.DOC_NO,
		   B.BOOKING_DATE,
		   B.PRICE,
		   B.BOOKING_STATUS,
		   B.CONSULT_DATE,
		   B.CONSULT_TIME,
		   M.NAME
	FROM BOOKING B JOIN MEMBER M
	ON B.PT_NO=M.MEMBER_NO
	WHERE B.CONSULT_DATE=TO_DATE(SYSDATE) AND MEMBER_NO=#{memberNo}
</select>

<!-- 예약관리 페이징 e.5-->
<!-- trim 한 것 따로 빼 낸것... -->
	<sql id="criterias">
		<trim prefix="(" suffix=") AND " prefixOverrides="OR">
			<foreach collection="typeArr" item="type">
				<!-- 콜렉션에 소문자시작 typeArr 써주면 자동으로 getMathod를 불러주는거임 -->
				<trim prefix="or">
					<choose>
						<when test="type == 'T'.toString()">
							TITLE LIKE '%'|| #{keyword} || '%'
						</when>

						<when test="type =='C'.toString()">
							CONTENT LIKE '%'|| #{keyword} || '%'
						</when>

						<when test="type =='W'.toString()">
							WRITER LIKE '%'|| #{keyword} || '%'
						</when>
					</choose>
				</trim>
			</foreach>
		</trim>
	</sql>
	
	<!-- total count -->
	<select id="getTotalPtbmCount" resultType="int">
		SELECT COUNT(*) FROM BOOKING
		WHERE
		<include refid="criterias"></include>
		BOOKING_NO > 0
	</select>

	<select id="getPtbmList" 
		resultType="com.mima.app.session.domain.BookingVO">
		SELECT *
		FROM( SELECT /*+INDEX_DESC(PATIENTS PATIENTS_PK) */
		ROWNUM RN, BOOKING_NO, PT_NO, DOC_NO, BOOKING_DATE, PRICE,
		BOOKING_STATUS, CONSULT_DATE, CONSULT_TIME,FIRST_SESSION, SUBJECT
		FROM BOOKING
		where
				
		<include refid="criterias"></include>
				<![CDATA[
				ROWNUM <= #{pageNum} * #{amount}				
				)
		WHERE RN > (#{pageNum}-1)* #{amount} ]]>
	</select>
<!-- 페이징 end -->

<!-- 환자대쉬보드 Main 진료내역 e.5-->
<select id="ptMainhisList" resultType="BookingVO">
<![CDATA[
	SELECT B.BOOKING_NO,
		   B.PT_NO,
		   B.DOC_NO,
		   B.BOOKING_DATE,
		   B.PRICE,
		   B.BOOKING_STATUS,
		   B.CONSULT_DATE,
		   B.CONSULT_TIME,
		   M.NAME
    FROM BOOKING B JOIN MEMBER M
    ON B.PT_NO=M.MEMBER_NO
    WHERE ROWNUM < 6 AND CONSULT_DATE < TO_DATE(SYSDATE) AND MEMBER_NO=#{memberNo}
    ORDER BY CONSULT_DATE DESC
 ]]>
</select>

<!-- 환자대쉬보드 진료내역 페이지 e.5-->
<select id="ptHistoryList" resultType="BookingVO">
	<![CDATA[
	SELECT B.BOOKING_NO,
		   B.PT_NO,
		   B.DOC_NO,
		   B.BOOKING_DATE,
		   B.PRICE,
		   B.BOOKING_STATUS,
		   B.CONSULT_DATE,
		   B.CONSULT_TIME,
		   M.NAME
	FROM BOOKING B JOIN MEMBER M
	ON B.PT_NO=M.MEMBER_NO
    WHERE B.CONSULT_DATE<TO_DATE(SYSDATE) AND BOOKING_STATUS = 'y' AND MEMBER_NO=#{memberNo}
	ORDER BY CONSULT_DATE DESC, CONSULT_TIME ASC
	]]>
</select>

<!-- 진료내역 페이징 e.6-->
<!-- trim 한 것 따로 빼 낸것... -->
	<sql id="criteriasa">
		<trim prefix="(" suffix=") AND " prefixOverrides="OR">
			<foreach collection="typeArr" item="type">
				<!-- 콜렉션에 소문자시작 typeArr 써주면 자동으로 getMathod를 불러주는거임 -->
				<trim prefix="or">
					<choose>
						<when test="type == 'T'.toString()">
							TITLE LIKE '%'|| #{keyword} || '%'
						</when>

						<when test="type =='C'.toString()">
							CONTENT LIKE '%'|| #{keyword} || '%'
						</when>

						<when test="type =='W'.toString()">
							WRITER LIKE '%'|| #{keyword} || '%'
						</when>
					</choose>
				</trim>
			</foreach>
		</trim>
	</sql>
	
	<!-- total count -->
	<select id="getTotalPthCount" resultType="int">
		SELECT COUNT(*) FROM BOOKING
		WHERE
		<include refid="criteriasa"></include>
		BOOKING_NO > 0
	</select>

	<select id="getPthList" 
		resultType="com.mima.app.session.domain.BookingVO">
		SELECT *
		FROM( SELECT /*+INDEX_DESC(BOOKING BOOKING_PK) */
		ROWNUM RN, BOOKING_NO, PT_NO, DOC_NO, BOOKING_DATE, PRICE,
		BOOKING_STATUS, CONSULT_DATE, CONSULT_TIME,FIRST_SESSION, SUBJECT
		FROM BOOKING
		where
				
		<include refid="criteriasa"></include>
				<![CDATA[
				ROWNUM <= #{pageNum} * #{amount}				
				)
		WHERE RN > (#{pageNum}-1)* #{amount} ]]>
	</select>
<!-- 페이징 end -->

<!-- 환자대쉬보드 Main 나의후기 e.5-->
<select id="ptMainreList" resultType="CommentsVO">
	<![CDATA[
		SELECT C.CMAIN_NO,
               C.COMMENT_WRITER_NO,
               C.CONTENTS,
               C.REVIEW_POINT,
               C.REG_DATE,
               M.NICKNAME
        FROM COMMENTS C JOIN MEMBER M
        ON C.COMMENT_WRITER_NO = M.MEMBER_NO
        WHERE ROWNUM < 6 AND MEMBER_NO=#{memberNo}
        ORDER BY REG_DATE DESC
		]]>
</select>

<!-- 환자대쉬보드 나의후기 페이지 e.5-->
	<select id="ptReviewList" resultType="CommentsVO">
		<![CDATA[
		SELECT C.CMAIN_NO,
               C.COMMENT_WRITER_NO,
               C.CONTENTS,
               C.REVIEW_POINT,
               C.REG_DATE,
               M.NICKNAME
        FROM COMMENTS C JOIN MEMBER M
        ON C.COMMENT_WRITER_NO = M.MEMBER_NO
        WHERE MEMBER_NO=#{memberNo}
        ORDER BY REG_DATE DESC
		]]>
	</select>

<!-- 나의후기 페이징 e.6-->
<!-- trim 한 것 따로 빼 낸것... -->
	<sql id="criteriasb">
		<trim prefix="(" suffix=") AND " prefixOverrides="OR">
			<foreach collection="typeArr" item="type">
				<!-- 콜렉션에 소문자시작 typeArr 써주면 자동으로 getMathod를 불러주는거임 -->
				<trim prefix="or">
					<choose>
						<when test="type == 'T'.toString()">
							TITLE LIKE '%'|| #{keyword} || '%'
						</when>

						<when test="type =='C'.toString()">
							CONTENT LIKE '%'|| #{keyword} || '%'
						</when>

						<when test="type =='W'.toString()">
							WRITER LIKE '%'|| #{keyword} || '%'
						</when>
					</choose>
				</trim>
			</foreach>
		</trim>
	</sql>
	
	<!-- total count -->
	<select id="getTotalPtrvCount" resultType="int">
		SELECT COUNT(*) FROM COMMENTS
		WHERE
		<include refid="criteriasb"></include>
		CMAIN_NO > 0
	</select>

	<select id="getPtrvList" 
		resultType="com.mima.app.comments.domain.CommentsVO">
		SELECT *
		FROM( SELECT /*+INDEX_DESC(COMMENTS COMMENTS_PK) */
		ROWNUM RN, CMAIN_CATEGORY, CMAIN_NO, COMMENT_WRITER_NO, CONTENTS, REVIEW_POINT, CNO
		FROM COMMENTS
		where
				
		<include refid="criteriasb"></include>
				<![CDATA[
				ROWNUM <= #{pageNum} * #{amount}				
				)
		WHERE RN > (#{pageNum}-1)* #{amount} ]]>
	</select>
	<!-- 페이징 end -->

	<!--환자대쉬보드 나의문의 페이지 e.6 -->
	<select id="ptQna" resultType="QnaVO">
		SELECT  C.CS_NO AS QNA_NO,
                C.CS_TITLE AS QNA_TITLE,
	            C.CS_DATE AS QNA_DATE,
                M.NAME AS QNA_NAME
		FROM CSC C JOIN MEMBER M
        ON (C.MEMBER_NO = M.MEMBER_NO)
        WHERE C.MEMBER_NO=#{memberNo}
	</select>

</mapper>